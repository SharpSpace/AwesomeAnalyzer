name: Release on tag

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build, create release and publish
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore NuGet packages
        run: dotnet restore "AwesomeAnalyzer.sln"

      - name: Build solution (Release)
        run: dotnet msbuild "AwesomeAnalyzer.sln" -t:Rebuild -p:Configuration=Release -p:DeployExtension=false

      - name: Find and copy VSIX to Setup folder
        shell: pwsh
        run: |
          $vsix = Get-ChildItem -Path . -Filter *.vsix -Recurse -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $vsix) { Write-Error "No .vsix found in repository after build."; exit 1 }
          New-Item -ItemType Directory -Path Setup -Force | Out-Null
          Copy-Item -Path $vsix.FullName -Destination (Join-Path -Path "Setup" -ChildPath $vsix.Name) -Force
          Write-Host "Copied VSIX to Setup\$($vsix.Name)"

      - name: Create release notes
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $notes = "# Release $tag`n`nAutomated release generated by GitHub Actions.`n"
          Set-Content -Path Setup/release-notes.md -Value $notes -Encoding UTF8

      - name: Create GitHub release and upload Setup contents
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          artifacts: Setup/*
          allowUpdates: true
          replacesArtifacts: true

      - name: Check Marketplace secrets
        id: check-marketplace-secrets
        shell: pwsh
        env:
          MARKETPLACE_PAT: ${{ secrets.MARKETPLACE_PAT }}
          MARKETPLACE_PUBLISHER: ${{ secrets.MARKETPLACE_PUBLISHER }}
        run: |
          if ([string]::IsNullOrEmpty($env:MARKETPLACE_PAT) -or [string]::IsNullOrEmpty($env:MARKETPLACE_PUBLISHER)) {
            Add-Content -Path $env:GITHUB_OUTPUT -Value 'have_secrets=false'
          } else {
            Add-Content -Path $env:GITHUB_OUTPUT -Value 'have_secrets=true'
          }

      - name: Publish to Visual Studio Marketplace (optional)
        if: ${{ steps.check-marketplace-secrets.outputs.have_secrets == 'true' }}
        shell: pwsh
        env:
          MARKETPLACE_PAT: ${{ secrets.MARKETPLACE_PAT }}
          MARKETPLACE_PUBLISHER: ${{ secrets.MARKETPLACE_PUBLISHER }}
        run: |
          # Get the most recently modified VSIX file (the one we just built)
          $vsix = Get-ChildItem -Path Setup -Filter *.vsix | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $vsix) { Write-Host "No VSIX found in Setup/ - skipping marketplace publish."; exit 0 }
          Write-Host "Publishing $($vsix.Name) to Visual Studio Marketplace (publisher: $env:MARKETPLACE_PUBLISHER)"
          # Call included script that performs the publish via TFX CLI
          .\Setup\publish-to-marketplace.ps1 -VsixPath $vsix.FullName -Publisher $env:MARKETPLACE_PUBLISHER -Pat $env:MARKETPLACE_PAT
